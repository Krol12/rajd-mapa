<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mapa Rajdu</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<style>
  body, html { margin: 0; padding: 0; height: 100%; }
  #map { height: 100%; }

  .day-menu { 
    position: absolute; 
    top: 50px; 
    left: 50%; 
    transform: translateX(-50%); 
    z-index: 1000; 
    background: white; 
    padding: 5px; 
    border-radius: 8px; 
    box-shadow: 0 2px 6px rgba(0,0,0,0.3);
  }
  .day-menu button { 
    margin: 2px; 
    padding: 8px 14px; 
    font-size: 16px; 
    border: none; 
    border-radius: 5px;
    background-color: #f0f0f0;
    cursor: pointer;
    transition: 0.2s;
  }
  .day-menu button:hover { background-color: #d0e0ff; }
  .day-menu button.active { background-color: #007bff; color: white; }

  #title { 
    position: absolute; 
    top: 10px; 
    left: 50%; 
    transform: translateX(-50%); 
    z-index: 1000; 
    background: white; 
    padding: 5px 15px; 
    border-radius: 8px; 
    font-size: 18px;
    font-weight: bold;
  }

  #message-box {
    position: absolute;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 1000;
    background: white;
    padding: 10px;
    border-radius: 8px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    display: none;
  }
  #message-box button {
    margin: 5px;
  }

  #locate-btn {
    position: absolute;
    bottom: 80px;
    left: 10px;
    z-index: 1000;
    padding: 8px 12px;
    background: #007bff;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
  }
</style>
</head>
<body>

<div id="title">Rajd w dniach ...</div>

<div class="day-menu">
  <button onclick="showDay(1)">Dzień 1</button>
  <button onclick="showDay(2)">Dzień 2</button>
  <button onclick="showDay(3)">Dzień 3</button>
  <button onclick="showDay(4)">Dzień 4</button>
  <button onclick="showDay(5)">Dzień 5</button>
</div>

<div id="map"></div>

<div id="message-box">
  <div id="message-text"></div>
  <button onclick="closeMessage()">OK</button>
  <button onclick="skipPoint()">Pomiń punkt</button>
</div>

<button id="locate-btn" onclick="locateUser()">Znajdź moją lokalizację</button>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
var map = L.map('map').setView([52.237, 21.017], 13);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19,
  attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

var pointsData = [];
var currentDay = 1;
var currentIndex = 0;
var markers = [];
var userMarker = null;

// Wczytanie punktów z JSON
fetch('punkty.json')
  .then(response => response.json())
  .then(data => {
      pointsData = data;
      showDay(1);
  })
  .catch(err => console.error("Błąd wczytywania punktów:", err));

function showDay(day){
  currentDay = day;
  currentIndex = 0;

  markers.forEach(m => map.removeLayer(m));
  markers = [];

  var dayPoints = pointsData.filter(p => Number(p.day) === currentDay);

  if(dayPoints.length === 0) return;

  dayPoints.forEach(p => {
      var m = L.marker([Number(p.lat), Number(p.lng)]).addTo(map).bindPopup(p.name);
      markers.push(m);
  });

  map.setView([Number(dayPoints[0].lat), Number(dayPoints[0].lng)], 15);
  updateDayButtons();
}

function updateDayButtons(){
  document.querySelectorAll('.day-menu button').forEach((btn, idx) => {
      btn.classList.toggle('active', idx+1 === currentDay);
  });
}

// Komunikaty
function showMessage(text){
  document.getElementById('message-text').innerText = text;
  document.getElementById('message-box').style.display = 'block';
}
function closeMessage(){
  document.getElementById('message-box').style.display = 'none';
}

// Ominięcie punktu
function skipPoint(){
  currentIndex++;
  closeMessage();
  var dayPoints = pointsData.filter(p => Number(p.day) === currentDay);
  if(currentIndex < dayPoints.length){
      showMessage("Następny punkt: " + dayPoints[currentIndex].name);
  } else {
      showMessage("Zaliczyłeś wszystkie punkty dnia " + currentDay);
  }
}

// Lokalizacja użytkownika
function locateUser(){
  map.locate({setView: false, maxZoom:16, watch:false});
}

function onLocationFound(e){
  if(!userMarker){
      userMarker = L.marker(e.latlng, {icon: L.icon({
          iconUrl:'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png', // czerwony marker
          iconSize:[25,41],
          iconAnchor:[12,41],
          popupAnchor:[1,-34]
      })}).addTo(map).bindPopup('Twoja pozycja');
  } else {
      userMarker.setLatLng(e.latlng);
  }
  checkNextPoint(e.latlng);
}

function checkNextPoint(latlng){
  var dayPoints = pointsData.filter(p => Number(p.day) === currentDay);
  if(currentIndex >= dayPoints.length) return;

  var target = dayPoints[currentIndex];
  var distance = map.distance(latlng, L.latLng(Number(target.lat), Number(target.lng)));

  if(distance < 50){ // zaliczenie w promieniu 50 m
      showMessage("Zaliczyłeś punkt: " + target.name);
      currentIndex++;
  }
}

map.on('locationfound', onLocationFound);
map.on('locationerror', function(e){ alert('Nie można określić lokalizacji: ' + e.message); });
</script>

</body>
</html>

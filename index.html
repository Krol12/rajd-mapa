<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mapa Rajdu</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<style>
  #map { height: 100vh; }

  /* Menu dni */
  .day-menu { 
    position: absolute; 
    top: 10px; 
    left: 50%; 
    transform: translateX(-50%); 
    z-index: 1000; 
    background: white; 
    padding: 5px; 
    border-radius: 8px; 
    box-shadow: 0 2px 6px rgba(0,0,0,0.3);
  }
  .day-menu button { 
    margin: 2px; 
    padding: 8px 14px; 
    font-size: 16px; 
    border: none; 
    border-radius: 5px;
    background-color: #f0f0f0;
    cursor: pointer;
    transition: 0.2s;
  }
  .day-menu button:hover { background-color: #d0e0ff; }
  .day-menu button.active { background-color: #007bff; color: white; }

  /* Kompas */
  .compass { 
    position: absolute; 
    bottom: 20px; 
    left: 50%; 
    transform: translateX(-50%) rotate(0deg); 
    font-size: 32px; 
    background: rgba(255,255,255,0.9); 
    width: 60px; 
    height: 60px; 
    display:flex; 
    align-items:center; 
    justify-content:center; 
    border-radius: 50%; 
    z-index: 1000; 
    transition: transform 0.2s;
    border: 2px solid #333;
    font-weight: bold;
  }
</style>
</head>
<body>

<div class="day-menu">
  <button onclick="showDay(1)">Dzień 1</button>
  <button onclick="showDay(2)">Dzień 2</button>
  <button onclick="showDay(3)">Dzień 3</button>
  <button onclick="showDay(4)">Dzień 4</button>
  <button onclick="showDay(5)">Dzień 5</button>
</div>

<div id="map"></div>
<div class="compass" id="compass">→</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
// Inicjalizacja mapy
var map = L.map('map').setView([52.237, 21.017], 13);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

let pointsData = [];
let currentDay = 1;
let currentIndex = 0;
let markers = [];
let userMarker = null;

// Wczytanie JSON-a z punktami
fetch('punkty.json')
  .then(res => res.json())
  .then(data => {
    pointsData = data;
    showDay(1);
  })
  .catch(err => console.error("Błąd wczytywania punktów:", err));

function setActiveButton(day) {
  document.querySelectorAll('.day-menu button').forEach(btn => btn.classList.remove('active'));
  document.querySelector(`.day-menu button:nth-child(${day})`).classList.add('active');
}

function showDay(day) {
  if (pointsData.length === 0) return;

  currentDay = day;
  currentIndex = 0;

  markers.forEach(m => map.removeLayer(m));
  markers = [];

  let dayPoints = pointsData.filter(p => p.day === day);
  dayPoints.forEach(p => {
    let m = L.marker([p.lat, p.lng], {icon: L.icon({
      iconUrl: 'https://maps.google.com/mapfiles/ms/icons/blue-dot.png',
      iconSize: [32,32],
      iconAnchor: [16,32]
    })}).addTo(map).bindPopup(p.name);
    markers.push(m);
  });

  if(dayPoints.length > 0) {
    map.setView([dayPoints[0].lat, dayPoints[0].lng], 15);
  }

  setActiveButton(day);
}

// Lokalizacja użytkownika
map.locate({setView: true, maxZoom:16, watch:true});

function updateDirection(latlng){
  let dayPoints = pointsData.filter(p => p.day === currentDay);
  if(currentIndex >= dayPoints.length) return;

  let target = dayPoints[currentIndex];
  let angle = Math.atan2(target.lng - latlng.lng, target.lat - latlng.lat) * (180 / Math.PI);
  document.getElementById('compass').style.transform = 'translateX(-50%) rotate(' + angle + 'deg)';

  let distance = map.distance(latlng, L.latLng(target.lat, target.lng));
  if(distance < 20){
    currentIndex++;
    if(currentIndex < dayPoints.length){
      alert('Zaliczyłeś punkt: ' + dayPoints[currentIndex].name);
    } else {
      alert('Zaliczyłeś wszystkie punkty dnia ' + currentDay);
    }
  }
}

function onLocationFound(e){
  if(!userMarker){
    userMarker = L.marker(e.latlng, {icon:L.icon({
      iconUrl:'https://maps.google.com/mapfiles/ms/icons/red-dot.png',
      iconSize:[32,32],
      iconAnchor:[16,32]
    })}).addTo(map).bindPopup('Twoja pozycja');
  } else {
    userMarker.setLatLng(e.latlng);
  }
  updateDirection(e.latlng);
}

map.on('locationfound', onLocationFound);
map.on('locationerror', function(e){ 
  alert('Nie można określić lokalizacji: ' + e.message); 
});
</script>

</body>
</html>
